<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heart AI - CAD Risk Assessment Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #1a365d;
      --accent: #00a8cc;
      --bg-dark: #0f1419;
      --bg-card: #1a2332;
      --text-primary: #ffffff;
      --text-secondary: #b0b8c1;
      --border: #2d3748;
      --danger: #e74c3c;
      --warning: #f39c12;
      --success: #27ae60;
    }

    body {
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-dark) 0%, var(--primary) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 10px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .logo {
      font-size: 1.3em;
      color: var(--accent);
      font-weight: bold;
      min-width: 150px;
    }

    .btn-back {
      padding: 8px 15px;
      background: var(--accent);
      color: var(--primary);
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-size: 0.9em;
    }

    .btn-back:hover {
      background: #0088aa;
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
      border-bottom: 2px solid var(--border);
      overflow-x: auto;
    }

    .tab-btn {
      padding: 10px 15px;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-weight: bold;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      white-space: nowrap;
      font-size: 0.9em;
    }

    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Progress Bar */
    .progress-container {
      margin-bottom: 20px;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #00d4ff);
      transition: width 0.3s ease;
    }

    .progress-text {
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.85em;
    }

    /* Form Sections */
    .form-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .section-title {
      font-size: 1em;
      color: var(--accent);
      margin-bottom: 15px;
      border-bottom: 2px solid var(--border);
      padding-bottom: 8px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 6px;
      color: var(--text-primary);
      font-weight: 500;
      font-size: 0.95em;
    }

    input[type="number"],
    select {
      width: 100%;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 1em;
    }

    input[type="number"]:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* MCQ Options */
    .mcq-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .mcq-option {
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9em;
    }

    .mcq-option:hover {
      background: rgba(0, 168, 204, 0.1);
      border-color: var(--accent);
    }

    .mcq-option.selected {
      background: rgba(0, 168, 204, 0.2);
      border-color: var(--accent);
    }

    .mcq-option input[type="radio"] {
      margin: 0;
    }

    /* Live Results Panel */
    .live-results {
      background: var(--bg-card);
      border: 2px solid var(--accent);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .live-results h3 {
      color: var(--accent);
      margin-bottom: 15px;
      text-align: center;
      font-size: 1.1em;
    }

    .risk-meter {
      margin-bottom: 15px;
    }

    .meter-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 0.8em;
    }

    .meter-bar {
      height: 25px;
      background: linear-gradient(90deg, var(--success) 0%, var(--warning) 50%, var(--danger) 100%);
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }

    .meter-indicator {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%;
      background: rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      font-weight: bold;
      font-size: 0.9em;
      transition: width 0.3s ease;
    }

    .risk-percentage {
      text-align: center;
      font-size: 2em;
      color: var(--accent);
      font-weight: bold;
      margin: 12px 0;
    }

    .risk-category {
      text-align: center;
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: bold;
      font-size: 1em;
    }

    .risk-category.low {
      background: rgba(39, 174, 96, 0.2);
      color: var(--success);
    }

    .risk-category.medium {
      background: rgba(243, 156, 18, 0.2);
      color: var(--warning);
    }

    .risk-category.high {
      background: rgba(231, 76, 60, 0.2);
      color: var(--danger);
    }

    /* History */
    .history-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.9em;
    }

    .history-item:hover {
      background: rgba(0, 168, 204, 0.1);
      border-color: var(--accent);
    }

    .history-date {
      color: var(--text-secondary);
      font-size: 0.85em;
      flex: 1;
      min-width: 150px;
    }

    .history-result {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .history-percentage {
      font-size: 1.3em;
      font-weight: bold;
      color: var(--accent);
      min-width: 45px;
      text-align: center;
    }

    .history-btn {
      padding: 6px 12px;
      background: var(--accent);
      color: var(--primary);
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85em;
      transition: all 0.2s;
    }

    .history-btn:hover {
      background: #0088aa;
    }

    /* Result Modal */
    .result-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 10px;
    }

    .result-modal.show {
      display: flex;
    }

    .result-content {
      background: var(--bg-card);
      border: 2px solid var(--accent);
      border-radius: 15px;
      padding: 20px;
      max-width: 500px;
      width: 100%;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0, 168, 204, 0.3);
      max-height: 90vh;
      overflow-y: auto;
    }

    .result-icon {
      font-size: 3.5em;
      margin-bottom: 15px;
    }

    .result-percentage {
      font-size: 2.5em;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .result-category {
      font-size: 1.3em;
      margin-bottom: 15px;
      padding: 12px;
      border-radius: 8px;
    }

    .result-message {
      color: var(--text-secondary);
      margin-bottom: 15px;
      line-height: 1.5;
      font-size: 0.95em;
    }

    .doctor-list {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      margin: 15px 0;
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.85em;
    }

    .doctor-item {
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }

    .doctor-item:last-child {
      border-bottom: none;
    }

    .doctor-name {
      color: var(--accent);
      font-weight: bold;
      margin-bottom: 4px;
      word-break: break-word;
    }

    .doctor-phone {
      color: var(--text-secondary);
      cursor: pointer;
      text-decoration: underline;
      display: block;
      margin-bottom: 3px;
    }

    .doctor-phone:hover {
      color: var(--accent);
    }

    .result-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .btn-primary,
    .btn-secondary {
      flex: 1;
      min-width: 120px;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-size: 0.9em;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #00d4ff);
      color: var(--primary);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 168, 204, 0.3);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Buttons */
    .button-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .button-group .btn-primary,
    .button-group .btn-secondary {
      flex: 1;
      min-width: 120px;
    }

    .empty-message {
      text-align: center;
      padding: 30px 15px;
      color: var(--text-secondary);
    }

    /* Responsive Layout */
    @media (max-width: 768px) {
      .container {
        max-width: 100%;
      }

      body {
        padding: 8px;
      }

      header {
        flex-direction: column;
        align-items: stretch;
      }

      .logo {
        text-align: center;
        min-width: auto;
      }

      .btn-back {
        width: 100%;
        text-align: center;
      }

      .form-section {
        padding: 12px;
        margin-bottom: 12px;
      }

      .section-title {
        font-size: 0.95em;
        margin-bottom: 12px;
      }

      .form-grid {
        display: grid !important;
        grid-template-columns: 1fr !important;
        gap: 12px !important;
      }

      .form-group {
        margin-bottom: 12px;
      }

      label {
        font-size: 0.9em;
        margin-bottom: 5px;
      }

      input[type="number"],
      select {
        padding: 9px;
        font-size: 16px;
      }

      .live-results {
        position: static;
        margin-bottom: 15px;
        padding: 12px;
      }

      .risk-percentage {
        font-size: 1.8em;
      }

      .risk-category {
        padding: 10px;
        font-size: 0.95em;
      }

      .mcq-option {
        padding: 9px;
        font-size: 0.85em;
        gap: 6px;
      }

      .button-group {
        gap: 8px;
        margin-top: 12px;
      }

      .button-group .btn-primary,
      .button-group .btn-secondary {
        min-width: 100px;
        padding: 10px;
        font-size: 0.85em;
      }

      .result-content {
        padding: 15px;
        border-radius: 12px;
      }

      .result-icon {
        font-size: 3em;
        margin-bottom: 10px;
      }

      .result-percentage {
        font-size: 2em;
      }

      .result-message {
        font-size: 0.9em;
      }

      .doctor-list {
        font-size: 0.8em;
        max-height: 180px;
      }

      .history-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .history-date {
        width: 100%;
      }

      .history-result {
        width: 100%;
        justify-content: space-between;
      }

      .tabs {
        gap: 3px;
        overflow-x: auto;
      }

      .tab-btn {
        padding: 8px 12px;
        font-size: 0.85em;
      }

      .progress-text {
        font-size: 0.8em;
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 6px;
      }

      .logo {
        font-size: 1.1em;
      }

      .btn-back {
        padding: 7px 12px;
        font-size: 0.85em;
      }

      .form-section {
        padding: 10px;
        margin-bottom: 10px;
      }

      .section-title {
        font-size: 0.9em;
      }

      .risk-percentage {
        font-size: 1.6em;
      }

      .button-group .btn-primary,
      .button-group .btn-secondary {
        min-width: 90px;
        padding: 8px;
        font-size: 0.8em;
      }

      .result-icon {
        font-size: 2.5em;
      }

      .result-percentage {
        font-size: 1.8em;
      }

      .doctor-list {
        font-size: 0.75em;
        max-height: 150px;
      }
    }
  </style>

</head>
<body>
  <div class="container">
    <header>
      <div class="logo">‚ù§Ô∏è Heart AI - CAD Test</div>
      <button class="btn-back" onclick="window.location.href='index.html'">‚Üê Back</button>
    </header>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('test')">üìã New Test</button>
      <button class="tab-btn" onclick="switchTab('history')">üìú History</button>
    </div>

    <!-- Test Tab -->
    <div class="tab-content active" id="testTab">
      <div style="display: grid; grid-template-columns: 1fr 300px; gap: 25px;">
        <!-- Main Form -->
        <div>
          <!-- Progress -->
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text">
              Completed: <span id="currentQuestion">0</span> of <span id="totalQuestions">21</span>
            </div>
          </div>

          <form id="testForm">
            <!-- Personal Information Section -->
            <div class="form-section">
              <div class="section-title">üìã Personal Information</div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                  <label>Age (years)</label>
                  <input type="number" id="age" min="18" max="100" required onchange="updateLiveResults()">
                </div>

                <div class="form-group">
                  <label>Gender</label>
                  <select id="gender" required onchange="updateLiveResults()">
                    <option value="">Select</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>Height (cm)</label>
                  <input type="number" id="height" min="100" max="250" required onchange="updateLiveResults()">
                </div>

                <div class="form-group">
                  <label>Weight (kg)</label>
                  <input type="number" id="weight" min="30" max="200" required onchange="updateLiveResults()">
                </div>
              </div>
            </div>

            <!-- Medical Parameters Section -->
            <div class="form-section">
              <div class="section-title">‚öïÔ∏è Medical Parameters</div>

              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                  <label>BP Systolic (mmHg)</label>
                  <input type="number" id="bpSystolic" min="70" max="200" required onchange="updateLiveResults()">
                </div>

                <div class="form-group">
                  <label>BP Diastolic (mmHg)</label>
                  <input type="number" id="bpDiastolic" min="40" max="130" required onchange="updateLiveResults()">
                </div>

                <div class="form-group">
                  <label>Cholesterol (mg/dL)</label>
                  <input type="number" id="cholesterol" min="100" max="400" required onchange="updateLiveResults()">
                </div>

                <div class="form-group">
                  <label>Diabetes</label>
                  <select id="diabetes" required onchange="updateLiveResults()">
                    <option value="">Select</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>Smoking/Alcohol</label>
                  <select id="smokingAlcohol" required onchange="updateLiveResults()">
                    <option value="">Select</option>
                    <option value="Never">Never</option>
                    <option value="Former">Former</option>
                    <option value="Current">Current</option>
                  </select>
                </div>

                <div class="form-group">
                  <label>Hypertension</label>
                  <select id="hypertension" required onchange="updateLiveResults()">
                    <option value="">Select</option>
                    <option value="Yes">Yes</option>
                    <option value="No">No</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Symptom Questions Section -->
            <div class="form-section">
              <div class="section-title">‚ùì Symptom Assessment (15 Questions)</div>
              <div id="questionsContainer"></div>
            </div>

            <div class="button-group">
              <button type="submit" class="btn-primary">Submit Test</button>
              <button type="reset" class="btn-secondary" onclick="resetForm()">Clear Form</button>
            </div>
          </form>
        </div>

        <!-- Live Results Panel -->
        <div class="live-results">
          <h3>Live Results</h3>

          <div class="risk-meter">
            <div class="meter-label">
              <span>Low</span>
              <span id="riskPercentageDisplay">0%</span>
              <span>High</span>
            </div>
            <div class="meter-bar">
              <div class="meter-indicator" id="meterIndicator" style="width: 0%;">
                <span id="meterText"></span>
              </div>
            </div>
          </div>

          <div class="risk-percentage" id="riskScore">0%</div>

          <div class="risk-category low" id="riskCategory">
            Low Risk
          </div>

          <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 15px;">
            <p id="riskDescription">Complete the form to see risk assessment</p>
          </div>
        </div>
      </div>
    </div>

    <!-- History Tab -->
    <div class="tab-content" id="historyTab">
      <div class="form-section">
        <div class="section-title">üìú Your Test History</div>
        <div id="historyContainer">
          <p style="text-align: center; color: var(--text-secondary);">No tests taken yet</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Result Modal -->
  <div class="result-modal" id="resultModal">
    <div class="result-content">
      <div class="result-icon" id="resultIcon">üéØ</div>
      <div class="result-percentage" id="resultPercentage">0%</div>
      <div class="result-category" id="resultCategoryDisplay">Low Risk</div>

      <div class="result-message" id="resultMessage">
        Your test has been completed successfully.
      </div>

      <!-- Doctor List for High Risk -->
      <div class="doctor-list" id="doctorList" style="display: none;">
        <strong style="color: var(--accent);">Recommended Doctors in Solapur:</strong>
        <div style="margin-top: 10px;" id="doctorListItems"></div>
      </div>

      <div class="result-buttons">
        <button class="btn-primary" onclick="goToFeedback()">üìù Go to Feedback</button>
        <button class="btn-secondary" onclick="closeResultModal()">‚úï Close</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://ktqwhwzbxyoplawjmbao.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt0cXdod3pieHlvcGxhd2ptYmFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMzQ2ODgsImV4cCI6MjA2ODYxMDY4OH0.mo0mu-k3b_saK3I4gAGr4OIZcGZdRF5ogFMTqeijKas';
    let supabase;
    let currentPredictionId = null;

    const questions = [
      "Do you often feel chest tightness or discomfort during physical exertion or stress?",
      "Have you noticed increased fatigue after normal activities, such as walking or climbing stairs?",
      "Do you experience pain or discomfort in your neck, jaw, or back?",
      "Do you often feel out of breath after moderate exertion, such as walking short distances?",
      "Have you ever had a sense of fullness or heaviness in your chest that comes and goes?",
      "Do you feel more tired or fatigued than usual, even after a full night's sleep?",
      "Have you experienced sharp or burning sensations in your chest that worsen with exertion?",
      "Do you sometimes feel pressure in your chest that radiates to your arms or shoulders?",
      "Have you ever felt unusually tired or weak after eating a large meal?",
      "Do you feel pain in your chest that gets worse when you breathe deeply or cough?",
      "Have you ever felt short of breath, even when sitting still or resting?",
      "Do you feel a squeezing sensation in your chest, especially during emotional stress?",
      "Have you experienced indigestion-like discomfort that does not go away with antacids?",
      "Do you feel as though your heart is beating too slowly or erratically, even without physical activity?",
      "Have you noticed your symptoms worsening in cold weather or when you are stressed"
    ];

    const doctors = [
      { name: "Janani Heart Care Clinic", phone: "+91 84838 09472", hours: "Mon-Wed, Fri-Sat: 11 AM-8 PM | Thu: 7 AM-8 PM | Sun: Closed", map: "https://maps.google.com/?q=Janani+Heart+Care+Clinic+Solapur" },
      { name: "Dr. Gurunath Parale - Spandan Cardiac Diagnostic Centre", phone: "+91 217 231 3979", hours: "Mon-Fri: 12 PM-7 PM | Sat: 12 PM-4 PM | Sun: Closed", map: "https://maps.google.com/?q=Spandan+Cardiac+Diagnostic+Centre+Solapur" },
      { name: "Dr. Anupam Shah Heart Clinic", phone: "+91 217 262 8877", hours: "Mon-Fri: 1-5 PM, 6-8 PM | Sat: 1-5 PM | Sun: Closed", map: "https://maps.google.com/?q=Dr+Anupam+Shah+Heart+Clinic+Solapur" },
      { name: "Dr. Shewale's Sai Heart & Maternity Care", phone: "+91 74474 45121", hours: "Mon-Sat: 10 AM-8 PM | Sun: Closed", map: "https://maps.google.com/?q=Sai+Heart+Maternity+Care+Solapur" },
      { name: "Samruddhi Heart Care", phone: "+91 82751 57576", hours: "Mon-Sat: 11 AM-9 PM | Sun: Closed", map: "https://maps.google.com/?q=Samruddhi+Heart+Care+Solapur" }
    ];

    function initializeSupabase() {
      try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        return true;
      } catch (error) {
        console.error('Supabase failed:', error);
        return false;
      }
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      
      if (tab === 'test') {
        document.getElementById('testTab').classList.add('active');
        document.querySelector('[onclick="switchTab(\'test\')"]').classList.add('active');
      } else {
        document.getElementById('historyTab').classList.add('active');
        document.querySelector('[onclick="switchTab(\'history\')"]').classList.add('active');
        loadHistory();
      }
    }

    function createQuestions() {
      const container = document.getElementById('questionsContainer');
      
      questions.forEach((question, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'form-group';
        questionDiv.innerHTML = `
          <label style="margin-bottom: 12px; display: block; font-weight: normal;">${index + 1}. ${question}</label>
          <div class="mcq-options">
            <label class="mcq-option" onclick="selectOption(this)">
              <input type="radio" name="q${index + 1}" value="0"> Strongly Disagree
            </label>
            <label class="mcq-option" onclick="selectOption(this)">
              <input type="radio" name="q${index + 1}" value="1"> Disagree
            </label>
            <label class="mcq-option" onclick="selectOption(this)">
              <input type="radio" name="q${index + 1}" value="2"> Neutral
            </label>
            <label class="mcq-option" onclick="selectOption(this)">
              <input type="radio" name="q${index + 1}" value="3"> Agree
            </label>
            <label class="mcq-option" onclick="selectOption(this)">
              <input type="radio" name="q${index + 1}" value="4"> Strongly Agree
            </label>
          </div>
        `;
        container.appendChild(questionDiv);
      });

      document.getElementById('totalQuestions').textContent = 21;
    }

    function selectOption(label) {
      const allLabels = label.parentElement.querySelectorAll('.mcq-option');
      allLabels.forEach(l => l.classList.remove('selected'));
      label.classList.add('selected');
      updateLiveResults();
    }

    function updateLiveResults() {
      const age = parseInt(document.getElementById('age').value) || 0;
      const bpSystolic = parseInt(document.getElementById('bpSystolic').value) || 0;
      const cholesterol = parseInt(document.getElementById('cholesterol').value) || 0;
      const diabetes = document.getElementById('diabetes').value;
      const hypertension = document.getElementById('hypertension').value;
      const smokingAlcohol = document.getElementById('smokingAlcohol').value;

      let riskScore = 0;

      if (age > 60) riskScore += 20;
      else if (age > 50) riskScore += 15;
      else if (age > 40) riskScore += 10;

      if (bpSystolic > 160) riskScore += 20;
      else if (bpSystolic > 140) riskScore += 15;
      else if (bpSystolic > 130) riskScore += 10;

      if (cholesterol > 300) riskScore += 20;
      else if (cholesterol > 240) riskScore += 15;
      else if (cholesterol > 200) riskScore += 10;

      if (diabetes === 'Yes') riskScore += 15;
      if (hypertension === 'Yes') riskScore += 15;

      if (smokingAlcohol === 'Current') riskScore += 20;
      else if (smokingAlcohol === 'Former') riskScore += 10;

      let symptomScore = 0;
      let answeredQuestions = 0;
      for (let i = 1; i <= questions.length; i++) {
        const checked = document.querySelector(`input[name="q${i}"]:checked`);
        if (checked) {
          symptomScore += parseInt(checked.value);
          answeredQuestions++;
        }
      }

      if (answeredQuestions > 0) {
        const symptomPercentage = (symptomScore / (answeredQuestions * 4)) * 30;
        riskScore += symptomPercentage;
      }

      riskScore = Math.min(riskScore, 100);
      riskScore = Math.max(riskScore, 0);

      const riskPercentage = Math.round(riskScore);
      document.getElementById('riskScore').textContent = riskPercentage + '%';
      document.getElementById('riskPercentageDisplay').textContent = riskPercentage + '%';
      
      const indicator = document.getElementById('meterIndicator');
      indicator.style.width = riskPercentage + '%';
      indicator.textContent = riskPercentage + '%';

      const categoryDiv = document.getElementById('riskCategory');
      const descriptionDiv = document.getElementById('riskDescription');

      categoryDiv.className = 'risk-category';
      
      if (riskPercentage < 20) {
        categoryDiv.classList.add('low');
        categoryDiv.textContent = '‚úì Low Risk';
        descriptionDiv.textContent = 'Your risk profile appears low. Continue healthy lifestyle choices.';
      } else if (riskPercentage < 40) {
        categoryDiv.classList.add('medium');
        categoryDiv.textContent = '‚ö† Medium Risk';
        descriptionDiv.textContent = 'You have some risk factors. Consider consulting a doctor.';
      } else if (riskPercentage < 60) {
        categoryDiv.classList.add('high');
        categoryDiv.textContent = '‚ö† High Risk';
        descriptionDiv.textContent = 'You should consult a doctor as soon as possible.';
      } else {
        categoryDiv.classList.add('high');
        categoryDiv.textContent = 'üî¥ Very High Risk';
        descriptionDiv.textContent = 'Seek immediate medical attention. Consult a cardiologist urgently.';
      }

      updateProgressBar();
    }

    function updateProgressBar() {
      let filledFields = 0;
      const totalFields = 21;

      if (document.getElementById('age').value) filledFields++;
      if (document.getElementById('gender').value) filledFields++;
      if (document.getElementById('height').value) filledFields++;
      if (document.getElementById('weight').value) filledFields++;
      if (document.getElementById('bpSystolic').value) filledFields++;
      if (document.getElementById('bpDiastolic').value) filledFields++;
      if (document.getElementById('cholesterol').value) filledFields++;
      if (document.getElementById('diabetes').value) filledFields++;
      if (document.getElementById('smokingAlcohol').value) filledFields++;
      if (document.getElementById('hypertension').value) filledFields++;

      for (let i = 1; i <= 15; i++) {
        if (document.querySelector(`input[name="q${i}"]:checked`)) {
          filledFields++;
        }
      }

      const progressPercent = (filledFields / totalFields) * 100;
      document.getElementById('progressFill').style.width = progressPercent + '%';
      document.getElementById('currentQuestion').textContent = filledFields;
    }

    function resetForm() {
      document.getElementById('testForm').reset();
      updateLiveResults();
    }

    document.getElementById('testForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const user = JSON.parse(localStorage.getItem('heartai_user'));
      if (!user) {
        alert('Please login first');
        return;
      }

      const riskPercentage = parseInt(document.getElementById('riskScore').textContent);
      
      const formData = {
        user_id: user.id,
        age: parseInt(document.getElementById('age').value),
        gender: document.getElementById('gender').value,
        height: parseFloat(document.getElementById('height').value),
        weight: parseFloat(document.getElementById('weight').value),
        blood_pressure_systolic: parseInt(document.getElementById('bpSystolic').value),
        blood_pressure_diastolic: parseInt(document.getElementById('bpDiastolic').value),
        cholesterol_level: parseInt(document.getElementById('cholesterol').value),
        has_diabetes: document.getElementById('diabetes').value === 'Yes',
        smoking_alcohol: document.getElementById('smokingAlcohol').value,
        has_hypertension: document.getElementById('hypertension').value === 'Yes',
        risk_percentage: riskPercentage,
        risk_category: document.getElementById('riskCategory').textContent.trim()
      };

      for (let i = 1; i <= 15; i++) {
        const checked = document.querySelector(`input[name="q${i}"]:checked`);
        const fieldNames = ['q1_chest_tightness', 'q2_fatigue', 'q3_neck_jaw_pain', 'q4_shortness_breath', 'q5_chest_fullness', 'q6_tired_unusual', 'q7_sharp_burning', 'q8_chest_pressure', 'q9_tired_after_meal', 'q10_chest_breath_pain', 'q11_shortness_resting', 'q12_squeezing_stress', 'q13_indigestion', 'q14_irregular_heartbeat', 'q15_symptoms_cold_stress'];
        formData[fieldNames[i-1]] = checked ? parseInt(checked.value) : 0;
      }

      try {
        await initializeSupabase();

        const { data, error } = await supabase
          .from('disease_predictions')
          .insert([formData])
          .select();

        if (error) throw error;

        currentPredictionId = data[0].id;

        // Show result modal
        showResultModal(riskPercentage, formData.risk_category);

        // Save to localStorage history
        let history = JSON.parse(localStorage.getItem('heartai_test_history') || '[]');
        history.unshift({
          id: data[0].id,
          date: new Date().toLocaleString(),
          percentage: riskPercentage,
          category: formData.risk_category
        });
        localStorage.setItem('heartai_test_history', JSON.stringify(history.slice(0, 50)));

      } catch (error) {
        alert('Error submitting test: ' + error.message);
      }
    });

    function showResultModal(percentage, category) {
      document.getElementById('resultPercentage').textContent = percentage + '%';
      document.getElementById('resultCategoryDisplay').className = 'result-category';
      
      if (percentage < 20) {
        document.getElementById('resultIcon').textContent = '‚úÖ';
        document.getElementById('resultCategoryDisplay').classList.add('low');
        document.getElementById('resultCategoryDisplay').textContent = 'Low Risk';
        document.getElementById('resultMessage').textContent = 'Great! Your risk profile is low. Maintain a healthy lifestyle with regular exercise and balanced diet.';
        document.getElementById('doctorList').style.display = 'none';
      } else if (percentage < 40) {
        document.getElementById('resultIcon').textContent = '‚ö†Ô∏è';
        document.getElementById('resultCategoryDisplay').classList.add('medium');
        document.getElementById('resultCategoryDisplay').textContent = 'Medium Risk';
        document.getElementById('resultMessage').textContent = 'You have some risk factors. Schedule a consultation with a healthcare professional.';
        document.getElementById('doctorList').style.display = 'none';
      } else if (percentage < 60) {
        document.getElementById('resultIcon').textContent = '‚ö†Ô∏è';
        document.getElementById('resultCategoryDisplay').classList.add('high');
        document.getElementById('resultCategoryDisplay').textContent = 'High Risk';
        document.getElementById('resultMessage').textContent = 'You should consult a cardiologist soon. Click below to contact recommended doctors.';
        showDoctors();
      } else {
        document.getElementById('resultIcon').textContent = 'üî¥';
        document.getElementById('resultCategoryDisplay').classList.add('high');
        document.getElementById('resultCategoryDisplay').textContent = 'Very High Risk';
        document.getElementById('resultMessage').textContent = 'Please seek immediate medical attention. Contact a cardiologist urgently!';
        showDoctors();
      }

      document.getElementById('resultModal').classList.add('show');
    }

    function showDoctors() {
      const doctorList = document.getElementById('doctorListItems');
      doctorList.innerHTML = '';
      
      doctors.forEach(doctor => {
        const item = document.createElement('div');
        item.className = 'doctor-item';
        item.innerHTML = `
          <div class="doctor-name">${doctor.name}</div>
          <div class="doctor-phone" onclick="callDoctor('${doctor.phone}')">üìû ${doctor.phone}</div>
          <div style="font-size: 0.85em; color: var(--text-secondary); margin-top: 5px;">${doctor.hours}</div>
          <div style="margin-top: 8px;">
            <a href="${doctor.map}" target="_blank" style="color: var(--accent); text-decoration: underline; font-size: 0.9em;">üó∫Ô∏è View on Google Maps</a>
          </div>
        `;
        doctorList.appendChild(item);
      });

      document.getElementById('doctorList').style.display = 'block';
    }

    function callDoctor(phone) {
      window.location.href = `tel:${phone}`;
    }

    function closeResultModal() {
      document.getElementById('resultModal').classList.remove('show');
    }

    function goToFeedback() {
      localStorage.setItem('heartai_current_prediction', currentPredictionId);
      window.location.href = 'feedback.html';
    }

    function loadHistory() {
      const history = JSON.parse(localStorage.getItem('heartai_test_history') || '[]');
      const container = document.getElementById('historyContainer');

      if (history.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No tests taken yet</p>';
        return;
      }

      container.innerHTML = history.map((test, index) => `
        <div class="history-item">
          <div>
            <div class="history-date">${test.date}</div>
            <div style="margin-top: 5px; color: var(--accent);">Risk: ${test.category}</div>
          </div>
          <div class="history-result">
            <div class="history-percentage">${test.percentage}%</div>
            <button class="history-btn" onclick="viewTestDetails('${test.id}')">View</button>
          </div>
        </div>
      `).join('');
    }

    function viewTestDetails(testId) {
      alert('Test ID: ' + testId + '\nDetailed view coming soon!');
    }

    window.addEventListener('DOMContentLoaded', () => {
      initializeSupabase();
      createQuestions();

      const user = localStorage.getItem('heartai_logged_in');
      if (!user) {
        alert('Please login first');
        window.location.href = 'index.html';
      }
    });
  </script>
</body>
</html>
