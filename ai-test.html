<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Heart AI - CAD Risk Assessment Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #1a365d;
      --accent: #00a8cc;
      --bg-dark: #0f1419;
      --bg-card: #1a2332;
      --text-primary: #ffffff;
      --text-secondary: #b0b8c1;
      --border: #2d3748;
      --danger: #e74c3c;
      --warning: #f39c12;
      --success: #27ae60;
    }

    body {
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      background: linear-gradient(135deg, var(--bg-dark) 0%, var(--primary) 100%);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .logo {
      font-size: 1.5em;
      color: var(--accent);
      font-weight: bold;
    }

    .btn-back {
      padding: 10px 20px;
      background: var(--accent);
      color: var(--primary);
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }

    .btn-back:hover {
      background: #0088aa;
    }

    /* Progress Bar */
    .progress-container {
      margin-bottom: 30px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #00d4ff);
      transition: width 0.3s ease;
    }

    .progress-text {
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.9em;
    }

    /* Form Sections */
    .form-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 25px;
    }

    .section-title {
      font-size: 1.2em;
      color: var(--accent);
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border);
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-primary);
      font-weight: 500;
    }

    input[type="number"],
    select {
      width: 100%;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 1em;
    }

    input[type="number"]:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* MCQ Options */
    .mcq-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .mcq-option {
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .mcq-option:hover {
      background: rgba(0, 168, 204, 0.1);
      border-color: var(--accent);
    }

    .mcq-option input[type="radio"] {
      cursor: pointer;
    }

    .mcq-option.selected {
      background: rgba(0, 168, 204, 0.2);
      border-color: var(--accent);
    }

    /* Live Results Panel */
    .live-results {
      background: var(--bg-card);
      border: 2px solid var(--accent);
      border-radius: 12px;
      padding: 25px;
      position: sticky;
      top: 20px;
      margin-bottom: 30px;
    }

    .live-results h3 {
      color: var(--accent);
      margin-bottom: 20px;
      text-align: center;
    }

    .risk-meter {
      margin-bottom: 25px;
    }

    .meter-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.9em;
    }

    .meter-bar {
      height: 30px;
      background: linear-gradient(90deg, var(--success) 0%, var(--warning) 50%, var(--danger) 100%);
      border-radius: 15px;
      overflow: hidden;
      position: relative;
    }

    .meter-indicator {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%;
      background: rgba(255, 255, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      font-weight: bold;
      transition: width 0.3s ease;
    }

    .risk-percentage {
      text-align: center;
      font-size: 2.5em;
      color: var(--accent);
      font-weight: bold;
      margin: 15px 0;
    }

    .risk-category {
      text-align: center;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: bold;
    }

    .risk-category.low {
      background: rgba(39, 174, 96, 0.2);
      color: var(--success);
    }

    .risk-category.medium {
      background: rgba(243, 156, 18, 0.2);
      color: var(--warning);
    }

    .risk-category.high {
      background: rgba(231, 76, 60, 0.2);
      color: var(--danger);
    }

    /* Buttons */
    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }

    .btn-primary,
    .btn-secondary {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #00d4ff);
      color: var(--primary);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(0, 168, 204, 0.3);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .live-results {
        position: static;
        margin-bottom: 30px;
      }

      .button-group {
        flex-direction: column;
      }

      .btn-primary,
      .btn-secondary {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">‚ù§Ô∏è Heart AI - CAD Test</div>
      <button class="btn-back" onclick="window.location.href='index.html'">‚Üê Back</button>
    </header>

    <div style="display: grid; grid-template-columns: 1fr 300px; gap: 25px;">
      <!-- Main Form -->
      <div>
        <!-- Progress -->
        <div class="progress-container">
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-text">
            Question <span id="currentQuestion">1</span> of <span id="totalQuestions">15</span>
          </div>
        </div>

        <form id="testForm">
          <!-- Personal Information Section -->
          <div class="form-section">
            <div class="section-title">üìã Personal Information</div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>Age (years)</label>
                <input type="number" id="age" min="18" max="100" required onchange="updateLiveResults()">
              </div>

              <div class="form-group">
                <label>Gender</label>
                <select id="gender" required onchange="updateLiveResults()">
                  <option value="">Select</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                </select>
              </div>

              <div class="form-group">
                <label>Height (cm)</label>
                <input type="number" id="height" min="100" max="250" required onchange="updateLiveResults()">
              </div>

              <div class="form-group">
                <label>Weight (kg)</label>
                <input type="number" id="weight" min="30" max="200" required onchange="updateLiveResults()">
              </div>
            </div>
          </div>

          <!-- Medical Parameters Section -->
          <div class="form-section">
            <div class="section-title">‚öïÔ∏è Medical Parameters</div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>Blood Pressure - Systolic (mmHg)</label>
                <input type="number" id="bpSystolic" min="70" max="200" required onchange="updateLiveResults()">
              </div>

              <div class="form-group">
                <label>Blood Pressure - Diastolic (mmHg)</label>
                <input type="number" id="bpDiastolic" min="40" max="130" required onchange="updateLiveResults()">
              </div>

              <div class="form-group">
                <label>Cholesterol Level (mg/dL)</label>
                <input type="number" id="cholesterol" min="100" max="400" required onchange="updateLiveResults()">
              </div>

              <div class="form-group">
                <label>Do you have Diabetes?</label>
                <select id="diabetes" required onchange="updateLiveResults()">
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>

              <div class="form-group">
                <label>Smoking/Alcoholic Status</label>
                <select id="smokingAlcohol" required onchange="updateLiveResults()">
                  <option value="">Select</option>
                  <option value="Never">Never</option>
                  <option value="Former">Former</option>
                  <option value="Current">Current</option>
                </select>
              </div>

              <div class="form-group">
                <label>Do you have Hypertension?</label>
                <select id="hypertension" required onchange="updateLiveResults()">
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Symptom Questions Section -->
          <div class="form-section">
            <div class="section-title">‚ùì Symptom Assessment (15 Questions)</div>

            <div id="questionsContainer"></div>
          </div>

          <div class="button-group">
            <button type="submit" class="btn-primary">Submit Test</button>
            <button type="reset" class="btn-secondary">Clear Form</button>
          </div>
        </form>
      </div>

      <!-- Live Results Panel (Sticky) -->
      <div class="live-results">
        <h3>Live Results</h3>

        <div class="risk-meter">
          <div class="meter-label">
            <span>Low</span>
            <span id="riskPercentageDisplay">0%</span>
            <span>High</span>
          </div>
          <div class="meter-bar">
            <div class="meter-indicator" id="meterIndicator" style="width: 0%;">
              <span id="meterText"></span>
            </div>
          </div>
        </div>

        <div class="risk-percentage" id="riskScore">0%</div>

        <div class="risk-category low" id="riskCategory">
          Low Risk
        </div>

        <div style="font-size: 0.9em; color: var(--text-secondary); margin-top: 15px;">
          <p id="riskDescription">Complete the form to see risk assessment</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://ktqwhwzbxyoplawjmbao.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt0cXdod3pieHlvcGxhd2ptYmFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMzQ2ODgsImV4cCI6MjA2ODYxMDY4OH0.mo0mu-k3b_saK3I4gAGr4OIZcGZdRF5ogFMTqeijKas';
    let supabase;

    const questions = [
      "Do you often feel chest tightness or discomfort during physical exertion or stress?",
      "Have you noticed increased fatigue after normal activities, such as walking or climbing stairs?",
      "Do you experience pain or discomfort in your neck, jaw, or back?",
      "Do you often feel out of breath after moderate exertion, such as walking short distances?",
      "Have you ever had a sense of fullness or heaviness in your chest that comes and goes?",
      "Do you feel more tired or fatigued than usual, even after a full night's sleep?",
      "Have you experienced sharp or burning sensations in your chest that worsen with exertion?",
      "Do you sometimes feel pressure in your chest that radiates to your arms or shoulders?",
      "Have you ever felt unusually tired or weak after eating a large meal?",
      "Do you feel pain in your chest that gets worse when you breathe deeply or cough?",
      "Have you ever felt short of breath, even when sitting still or resting?",
      "Do you feel a squeezing sensation in your chest, especially during emotional stress?",
      "Have you experienced indigestion-like discomfort that does not go away with antacids?",
      "Do you feel as though your heart is beating too slowly or erratically, even without physical activity?",
      "Have you noticed your symptoms worsening in cold weather or when you are stressed"
    ];

    function initializeSupabase() {
      try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        return true;
      } catch (error) {
        console.error('Supabase failed:', error);
        return false;
      }
    }

    function createQuestions() {
      const container = document.getElementById('questionsContainer');
      
      questions.forEach((question, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'form-group';
        questionDiv.innerHTML = `
          <label style="margin-bottom: 12px; display: block;">${index + 1}. ${question}</label>
          <div class="mcq-options">
            <label class="mcq-option" onclick="selectOption(this)">
              <input type="radio" name="q${index + 1}" value="0"> Strongly Disagree
            </label>
            <label class="mcq-option" onclick="selectOption(this)">
              <input type="radio" name="q${index + 1}" value="1"> Disagree
            </label>
            <label class="mcq-option" onclick="selectOption(this)">
              <input type="radio" name="q${index + 1}" value="2"> Neutral
            </label>
            <label class="mcq-option" onclick="selectOption(this)">
              <input type="radio" name="q${index + 1}" value="3"> Agree
            </label>
            <label class="mcq-option" onclick="selectOption(this)">
              <input type="radio" name="q${index + 1}" value="4"> Strongly Agree
            </label>
          </div>
        `;
        container.appendChild(questionDiv);
      });

      document.getElementById('totalQuestions').textContent = questions.length;
    }

    function selectOption(label) {
      const allLabels = label.parentElement.querySelectorAll('.mcq-option');
      allLabels.forEach(l => l.classList.remove('selected'));
      label.classList.add('selected');
      updateLiveResults();
    }

    function updateLiveResults() {
      const age = parseInt(document.getElementById('age').value) || 0;
      const bpSystolic = parseInt(document.getElementById('bpSystolic').value) || 0;
      const cholesterol = parseInt(document.getElementById('cholesterol').value) || 0;
      const diabetes = document.getElementById('diabetes').value;
      const hypertension = document.getElementById('hypertension').value;
      const smokingAlcohol = document.getElementById('smokingAlcohol').value;

      let riskScore = 0;

      // Age factor
      if (age > 60) riskScore += 20;
      else if (age > 50) riskScore += 15;
      else if (age > 40) riskScore += 10;

      // Blood pressure factor
      if (bpSystolic > 160) riskScore += 20;
      else if (bpSystolic > 140) riskScore += 15;
      else if (bpSystolic > 130) riskScore += 10;

      // Cholesterol factor
      if (cholesterol > 300) riskScore += 20;
      else if (cholesterol > 240) riskScore += 15;
      else if (cholesterol > 200) riskScore += 10;

      // Diabetes factor
      if (diabetes === 'Yes') riskScore += 15;

      // Hypertension factor
      if (hypertension === 'Yes') riskScore += 15;

      // Smoking/Alcohol factor
      if (smokingAlcohol === 'Current') riskScore += 20;
      else if (smokingAlcohol === 'Former') riskScore += 10;

      // Symptom questions factor
      let symptomScore = 0;
      let answeredQuestions = 0;
      for (let i = 1; i <= questions.length; i++) {
        const checked = document.querySelector(`input[name="q${i}"]:checked`);
        if (checked) {
          symptomScore += parseInt(checked.value);
          answeredQuestions++;
        }
      }

      if (answeredQuestions > 0) {
        const symptomPercentage = (symptomScore / (answeredQuestions * 4)) * 30;
        riskScore += symptomPercentage;
      }

      // Cap at 100
      riskScore = Math.min(riskScore, 100);
      riskScore = Math.max(riskScore, 0);

      // Update display
      const riskPercentage = Math.round(riskScore);
      document.getElementById('riskScore').textContent = riskPercentage + '%';
      document.getElementById('riskPercentageDisplay').textContent = riskPercentage + '%';
      
      const indicator = document.getElementById('meterIndicator');
      indicator.style.width = riskPercentage + '%';
      indicator.textContent = riskPercentage + '%';

      // Update category and description
      const categoryDiv = document.getElementById('riskCategory');
      const descriptionDiv = document.getElementById('riskDescription');

      categoryDiv.className = 'risk-category';
      
      if (riskPercentage < 20) {
        categoryDiv.classList.add('low');
        categoryDiv.textContent = '‚úì Low Risk';
        descriptionDiv.textContent = 'Your current risk profile appears to be low. Continue with healthy lifestyle choices.';
      } else if (riskPercentage < 40) {
        categoryDiv.classList.add('medium');
        categoryDiv.textContent = '‚ö† Medium Risk';
        descriptionDiv.textContent = 'You have some risk factors. Consider consulting a healthcare professional.';
      } else if (riskPercentage < 60) {
        categoryDiv.classList.add('high');
        categoryDiv.textContent = '‚ö† High Risk';
        descriptionDiv.textContent = 'You should consult a doctor as soon as possible.';
      } else {
        categoryDiv.classList.add('high');
        categoryDiv.textContent = 'üî¥ Very High Risk';
        descriptionDiv.textContent = 'Please seek immediate medical attention. Consult a cardiologist urgently.';
      }

      updateProgressBar();
    }

    function updateProgressBar() {
      let filledFields = 0;
      let totalFields = 21; // 6 personal + 6 medical + 15 questions

      if (document.getElementById('age').value) filledFields++;
      if (document.getElementById('gender').value) filledFields++;
      if (document.getElementById('height').value) filledFields++;
      if (document.getElementById('weight').value) filledFields++;
      if (document.getElementById('bpSystolic').value) filledFields++;
      if (document.getElementById('bpDiastolic').value) filledFields++;
      if (document.getElementById('cholesterol').value) filledFields++;
      if (document.getElementById('diabetes').value) filledFields++;
      if (document.getElementById('smokingAlcohol').value) filledFields++;
      if (document.getElementById('hypertension').value) filledFields++;

      for (let i = 1; i <= 15; i++) {
        if (document.querySelector(`input[name="q${i}"]:checked`)) {
          filledFields++;
        }
      }

      const progressPercent = (filledFields / totalFields) * 100;
      document.getElementById('progressFill').style.width = progressPercent + '%';
      document.getElementById('currentQuestion').textContent = filledFields;
    }

    document.getElementById('testForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      const user = JSON.parse(localStorage.getItem('heartai_user'));
      if (!user) {
        alert('Please login first');
        return;
      }

      const formData = {
        user_id: user.id,
        age: parseInt(document.getElementById('age').value),
        gender: document.getElementById('gender').value,
        height: parseFloat(document.getElementById('height').value),
        weight: parseFloat(document.getElementById('weight').value),
        blood_pressure_systolic: parseInt(document.getElementById('bpSystolic').value),
        blood_pressure_diastolic: parseInt(document.getElementById('bpDiastolic').value),
        cholesterol_level: parseInt(document.getElementById('cholesterol').value),
        has_diabetes: document.getElementById('diabetes').value === 'Yes',
        smoking_alcohol: document.getElementById('smokingAlcohol').value,
        has_hypertension: document.getElementById('hypertension').value === 'Yes'
      };

      // Add question answers
      for (let i = 1; i <= 15; i++) {
        const checked = document.querySelector(`input[name="q${i}"]:checked`);
        formData[`q${i}_${['chest_tightness', 'fatigue', 'neck_jaw_pain', 'shortness_breath', 'chest_fullness', 'tired_unusual', 'sharp_burning', 'chest_pressure', 'tired_after_meal', 'chest_breath_pain', 'shortness_resting', 'squeezing_stress', 'indigestion', 'irregular_heartbeat', 'symptoms_cold_stress'][i-1]}`] = parseInt(checked.value);
      }

      // Calculate risk
      const riskPercentage = parseInt(document.getElementById('riskScore').textContent);
      formData.risk_percentage = riskPercentage;
      
      if (riskPercentage < 20) formData.risk_category = 'Low';
      else if (riskPercentage < 40) formData.risk_category = 'Medium';
      else if (riskPercentage < 60) formData.risk_category = 'High';
      else formData.risk_category = 'Very High';

      try {
        await initializeSupabase();

        const { error } = await supabase
          .from('disease_predictions')
          .insert([formData]);

        if (error) throw error;

        alert('Test submitted successfully!');
        window.location.href = 'feedback.html?prediction=done';

      } catch (error) {
        alert('Error submitting test: ' + error.message);
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      initializeSupabase();
      createQuestions();

      // Check if user is logged in
      const user = localStorage.getItem('heartai_logged_in');
      if (!user) {
        alert('Please login first');
        window.location.href = 'index.html';
      }
    });
  </script>
</body>
</html>
